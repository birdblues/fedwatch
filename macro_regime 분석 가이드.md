# `macro_regime` 테이블 분석 가이드

이 문서는 Supabase `public.macro_regime` 테이블을 기반으로 **매크로 레짐을 해석·시각화·포트폴리오 비중 조절**까지 연결하는 실무형 분석 방법을 정리합니다.  
(현재 파이프라인 기준: 월말(Month-End) 스냅샷, 레짐만 저장)

---

## 1) 테이블 스키마와 의미

### 컬럼 정의
- `date` (date, PK)
  - **월말 기준 레짐 날짜** (예: 2026-01-31)
- `regime_id` (int)
  - 4분면 레짐 ID
- `regime_label` (text)
  - 레짐 이름(문자 라벨)
- `stress_flag` (bool)
  - 금융 스트레스(신용/커브 기반) 경고 플래그  
  - **레짐 자체는 안 바꾸고**, “같은 레짐 안에서도 위험도”를 구분하는 용도
- `updated_at` (timestamptz)
  - 파이프라인이 마지막으로 업서트한 시각

---

## 2) 레짐 체계(4분면)의 해석

현재 구현은 다음 논리로 4분면을 구성합니다.

- Growth 축(성장): **제조업 신규주문(AMTMNO) 기반**
  - `orders_yoy`(YoY) + `orders_mom`(3개월 변화) + `unrate_chg_3m`(실업률 3개월 변화)
- Inflation 축(물가): **Core CPI YoY 기반**
  - `core_cpi_yoy`가 **롤링 중앙값(36개월)** 대비 높거나, 절대 기준(>=3%) 이상이면 “hot”

### regime_id / label 의미
| regime_id | regime_label  | 성장 | 물가 | 일반적 매크로 해석 |
|---:|---|---|---|---|
| 1 | Goldilocks | + | - | 성장 양호 + 물가 부담 낮음 |
| 2 | Reflation  | + | + | 성장 양호 + 물가 압력(긴축/금리상승 가능) |
| 3 | Stagflation| - | + | 성장 둔화 + 물가 압력(가장 불리한 조합) |
| 4 | Recession  | - | - | 성장 둔화 + 디스인플레/침체 성격 |

> 주의: “Recession”은 **공식 경기침체 선언**이 아니라, 본 파이프라인의 **성장/물가 신호 조합**에서 (G-, I-)로 분류된 상태입니다.

---

## 3) stress_flag 해석 (레짐과 별개 레이어)

`stress_flag`는 “레짐”이 아니라 **위험/스트레스 레이어**입니다.

- 현재 정의(파이프라인 기준):
  - `yc_10y2y < 0` (커브 역전) AND
  - `robust_zscore(hy_oas) > 1.0` (하이일드 스프레드가 최근 대비 크게 확대)

### 실무 해석
- `stress_flag = True`
  - **신용 스트레스 + 커브 경고가 동시에** 뜬 상태  
  - 같은 레짐이라도 “리스크 오프 강도”가 더 커질 가능성
- `stress_flag = False`
  - 레짐이 나쁘더라도 “신용위기 급변” 같은 이벤트형 스트레스는 아직 아님(단, 예외 가능)

---

## 4) 기본 분석 흐름(추천 루틴)

### Step A. 최신 레짐 확인 (상태판)
- “이번 월말 기준 현재 레짐은 무엇인가?”
- “stress_flag가 켜졌는가?”

### Step B. 전환 탐지(레짐 변화)
- 최근 N개월에서 **regime_id가 바뀐 시점**을 찾기
- “레짐 전환 직후 성과/변동성”이 어떻게 바뀌는지 확인

### Step C. 레짐 지속성(체류기간) 분석
- 각 레짐에서 평균 몇 개월 머무는지
- 특정 레짐에서 다음 레짐으로 전이될 확률(간이 Markov 전이) 추정

### Step D. stress_flag 조건부 분석
- `stress_flag=True` 구간의 평균 낙폭/변동성/리스크지표가 일반 구간과 얼마나 다른지 비교
- 특히 `regime_id=4`에서 stress_flag=True가 겹칠 때는 “침체+신용” 성격이 강해질 수 있음

---

## 5) 대시보드 시각화 아이디어 (프론트 구현 기준)

### (1) 레짐 타임라인(핵심)
- x축: date
- y축(또는 컬러 밴드): regime_id (1~4)
- 오버레이: stress_flag가 True인 달은 마커/음영으로 표시

### (2) 레짐 분포(파이 차트/막대)
- 기간별(전체/최근 5년/최근 2년) 레짐 비중
- “최근 구간이 역사 대비 어느 레짐에 치우쳤는지” 확인

### (3) 레짐 전환 히트맵(전이행렬)
- from-regime → to-regime 카운트
- “어느 전환이 자주 발생하는지” 파악

### (4) 레짐 vs 자산 성과(백테스트 패널)
- 레짐별로 S&P500, 장기채, IG/HY, 금, 원유 등 성과 요약
- stress_flag=True 구간 별도 분리

---

## 6) 포트폴리오 비중조절(간단 룰 템플릿)

> 아래는 “레짐만 저장” 구조에서 프론트/리밸런싱 로직으로 연결하기 쉬운 형태의 룰 예시입니다.  
> (정답이 아니라 시작점입니다)

### 기본 원칙
- 레짐은 “방향성”, stress_flag는 “강도(방어수준)”로 사용

### 예시: 리스크 자산(주식) 비중
- regime 1 (Goldilocks): 주식 ↑, 크레딧/성장주/소형주 우호
- regime 2 (Reflation): 주식 중립~↑, 다만 금리상승 민감 자산 주의(장기채/고PER)
- regime 3 (Stagflation): 주식 ↓, 인플레 헤지(원자재/금) ↑, 듀레이션 관리
- regime 4 (Recession): 주식 ↓, 방어(현금/단기채/퀄리티) ↑

### stress_flag가 True일 때(추가 방어 오버레이)
- 동일 레짐에서도 **주식/하이일드/고베타를 한 단계 더 축소**
- 리밸런싱 빈도는 “급변 구간”이므로 월 1회보다 짧게(단, 거래비용 고려)

---

## 7) 실무 쿼리 예시(SQL)

### 최신 1개
```sql
select *
from public.macro_regime
order by date desc
limit 1;
